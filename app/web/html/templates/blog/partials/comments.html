<section id="comments-section">
  <div class="">
    <div
      class="flex max-sm:flex-col gap-4 mb-2 my-16 text-5xl font-bold not-prose"
    >
      {{ render_partial('blog/partials/like_button.html', request=request, blog_post=blog_post, liked=liked) }}
      <h2 id="comments" x-intersect="highlightTocElement('comments')">
        Comments ({{ blog_post.comments|length }})
      </h2>
    </div>
    <hr />

    {% if blog_post.comments %}
      <div class="mt-6 text-lg flex flex-col gap-12">
        {% for comment in blog_post.comments %}
          {{ render_partial('blog/partials/comment.html', request=request, comment=comment) }}
        {% endfor %}
      </div>
    {% endif %}

    <form
      class="not-prose mt-12 text-lg px-2"
      id="main-comment-form"
      hx-post="{{ url_for('html:comment_blog_post', bp_id=blog_post.id) }}"
      hx-target="#comments-section"
      hx-target-error="#comments-section"
      hx-swap="outerHTML"
    >
      {{ render_partial('shared/partials/flash_message.html', message=message) }}
      {% if not current_user.is_authenticated %}
        {{ render_partial('shared/partials/forms/hidden_field.html', field=comment_form.check_me) }}
      {% endif %}
      <div class="flex flex-col gap-6 mb-8">
        {% if current_user.is_authenticated %}
          <p class="text-2xl font-semibold">
            Submit a comment as
            <span class="text-offset-700 dark:text-offset-400 font-bold"
              >{{ current_user.username }}</span
            >:
          </p>
        {% else %}
          <div class="flex max-md:flex-col gap-6">
            {{ render_partial('shared/partials/forms/field.html', class="flex-1", field=comment_form.name) }}
            {{ render_partial('shared/partials/forms/toggle_field.html', field=comment_form.not_robot) }}
          </div>
          {{ render_partial('shared/partials/forms/field.html', field=comment_form.email) }}
        {% endif %}
        {{ render_partial('shared/partials/forms/field.html', field=comment_form.content, extra_fields={"rows": "5", "hx-post": url_for('html:comment_post_preview', bp_id=blog_post.id), "hx-trigger": "keyup changed delay:1000ms", "hx-target": "#comment-preview", "hx-swap": "innerHTML"}) }}
      </div>
      {{ render_partial('shared/partials/forms/submit_button.html', text="Submit", extra_fields={"@click": "smoothScroll = false; setTimeout(() => smoothScroll = true, 500)"}) }}
    </form>
  </div>
  <div id="comment-preview" class="mt-12 text-lg"></div>
</section>
